<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é¦¬åˆ°æˆåŠŸï¼šåˆé¦¬é–‹é‹åˆ®</title>
    <script src="https://unpkg.com/vconsole@latest/dist/vconsole.min.js"></script>
    <script>var vConsole = new window.VConsole();</script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&family=Noto+Sans+TC:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background: radial-gradient(circle at center, #7f1d1d 0%, #2a0505 100%); margin: 0; overflow: hidden; height: 100vh; color: white; }
        .font-calligraphy { font-family: 'Ma Shan Zheng', cursive; }
        #loading-overlay { position: fixed; inset: 0; background: #2a0505; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        /* åˆ®åˆ®å¡å®¹å™¨ */
        .scratch-container { position: relative; width: 300px; height: 150px; margin: 20px auto; background: #f59e0b; border-radius: 15px; overflow: hidden; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        .prize-text { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: 900; color: #7f1d1d; z-index: 1; }
        canvas { position: absolute; inset: 0; z-index: 2; touch-action: none; cursor: crosshair; }
        .btn-gold { background: linear-gradient(to bottom, #f59e0b, #b45309); color: #2a0505; font-weight: 900; padding: 12px 24px; border-radius: 99px; transition: 0.3s; }
        .btn-gold:active { transform: scale(0.95); }
    </style>
</head>
<body>
    <div id="loading-overlay">
        <div class="text-6xl mb-4 animate-bounce">ğŸ§§</div>
        <div id="loading-text" class="text-xl font-bold font-calligraphy text-amber-400">æ­£åœ¨ç¢ºèªé–‹é‹è³‡æ ¼...</div>
    </div>

    <div class="flex flex-col items-center justify-center min-h-screen p-4 text-center">
        <h1 class="text-5xl font-calligraphy text-amber-400 mb-2 drop-shadow-lg">é¦¬åˆ°æˆåŠŸ</h1>
        <p class="text-amber-200/60 text-sm tracking-widest mb-8">åˆé¦¬é–‹é‹åˆ®åˆ®æ¨‚</p>

        <div class="scratch-container" id="scratch-box">
            <div class="prize-text" id="prize-display">ğŸ 50å…ƒæŠ˜åƒ¹åˆ¸</div>
            <canvas id="scratch-canvas"></canvas>
        </div>

        <div id="status-msg" class="text-amber-200 text-sm mt-4 h-6">è«‹åœ¨ä¸Šæ–¹é‡‘è‰²å€å¡Šåˆ®ç</div>
        
        <button onclick="liff.closeWindow()" class="btn-gold mt-10">è¿”å› LINE</button>
    </div>

    <script>
        const LIFF_ID = '1569792743-bsbm1zLE'; 
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbwsmCxklPsVoozRdPggUmh81IXatVZfWEG9dAD7iDkNwQHWJKoJe-idX4BLmF1_GLzZGg/exec';
        let userUID = "";

        // 1. åˆå§‹åŒ– LIFF èˆ‡ æª¢æŸ¥è³‡æ ¼
        async function init() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) { liff.login(); return; }
                const profile = await liff.getProfile();
                userUID = profile.userId;
                console.log("UID:", userUID);

                const res = await fetch(GAS_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'check', userId: userUID })
                });
                const data = await res.json();

                if (data.canPlay) {
                    document.getElementById('loading-overlay').style.display = 'none';
                    setupScratchCard();
                } else {
                    document.getElementById('loading-text').innerHTML = "âŒ æ‚¨å·²åƒåŠ éæœ¬æ´»å‹•<br><small>æ¯ä½æœƒå“¡é™åƒåŠ ä¸€æ¬¡</small>";
                }
            } catch (e) {
                console.error(e);
                document.getElementById('loading-overlay').style.display = 'none';
                setupScratchCard(); // å¤±æ•—ä¹Ÿè®“å®ƒè·‘ï¼Œæ–¹ä¾¿æ¸¬è©¦
            }
        }

        // 2. åˆ®åˆ®å¡é‚è¼¯ (å–ä»£åŸæœ¬è¤‡é›œçš„çµ„ä»¶)
        function setupScratchCard() {
            const canvas = document.getElementById('scratch-canvas');
            const ctx = canvas.getContext('2d');
            const box = document.getElementById('scratch-box');
            canvas.width = box.offsetWidth;
            canvas.height = box.offsetHeight;

            // å¡«æ»¿é‡‘è‰²é®è“‹å±¤
            ctx.fillStyle = '#d97706';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.font = '20px serif';
            ctx.fillStyle = '#fef3c7';
            ctx.textAlign = 'center';
            ctx.fillText('åˆ®é–‹é ˜å¥½é‹', canvas.width/2, canvas.height/2 + 7);

            let isDrawing = false;
            let scratchedPercent = 0;

            function scratch(e) {
                if (!isDrawing) return;
                const rect = canvas.getBoundingClientRect();
                const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
                const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;

                ctx.globalCompositeOperation = 'destination-out';
                ctx.beginPath();
                ctx.arc(x, y, 20, 0, Math.PI * 2);
                ctx.fill();
                checkScratch();
            }

            function checkScratch() {
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const pixels = imageData.data;
                let transparent = 0;
                for (let i = 0; i < pixels.length; i += 4) {
                    if (pixels[i + 3] < 128) transparent++;
                }
                const percent = (transparent / (pixels.length / 4)) * 100;
                if (percent > 40 && scratchedPercent <= 40) {
                    scratchedPercent = 100;
                    canvas.style.transition = 'opacity 0.5s';
                    canvas.style.opacity = '0';
                    handleWin();
                }
            }

            canvas.addEventListener('mousedown', () => isDrawing = true);
            canvas.addEventListener('touchstart', () => isDrawing = true);
            window.addEventListener('mouseup', () => isDrawing = false);
            window.addEventListener('touchend', () => isDrawing = false);
            canvas.addEventListener('mousemove', scratch);
            canvas.addEventListener('touchmove', scratch);
        }

        async function handleWin() {
            document.getElementById('status-msg').innerText = "ğŸ‰ æ­å–œä¸­çï¼æ­£åœ¨ç´€éŒ„çé …...";
            try {
                await fetch(GAS_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'save', userId: userUID, prize: "50å…ƒæŠ˜åƒ¹åˆ¸" })
                });
                document.getElementById('status-msg').innerText = "âœ… çé …å·²å­˜å…¥æ‚¨çš„å¸³è™Ÿï¼";
            } catch (e) {
                console.error(e);
            }
        }

        window.onload = init;
    </script>
</body>
</html>
